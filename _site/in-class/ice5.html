<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Muhamad Ameer Noor">
<meta name="dcterms.date" content="2023-12-16">

<title>ISSS624 - Applied Geospatial Analytics - In-class Exercise 4 - Spatial Econometric Interaction Models (SIEM)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ISSS624 - Applied Geospatial Analytics</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-hands-on-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Hands-on Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-hands-on-exercise">    
        <li>
    <a class="dropdown-item" href="../hands-on/hoe1.html" rel="" target="">
 <span class="dropdown-text">1A - Geospatial Data Wrangling</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe1-choropleth.html" rel="" target="">
 <span class="dropdown-text">1B - Choropleth Mapping</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe2-spatialweight.html" rel="" target="">
 <span class="dropdown-text">2A - Spatial Weights and Application</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe2-globalautocor.html" rel="" target="">
 <span class="dropdown-text">2B - Global Measures of Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe2-localautocor.html" rel="" target="">
 <span class="dropdown-text">2C - Local Measures of Spatial Autocorrelation</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe3.html" rel="" target="">
 <span class="dropdown-text">3 - Flow Data</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../hands-on/hoe4.html" rel="" target="">
 <span class="dropdown-text">4 - Geographically Weighted Regression (GWR)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-in-class-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">In-class Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-in-class-exercise">    
        <li>
    <a class="dropdown-item" href="../in-class/ice1.html" rel="" target="">
 <span class="dropdown-text">1 - Preparing The Data Flow</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../in-class/ice2.html" rel="" target="">
 <span class="dropdown-text">2 - sfdep for Spatial Weights, GLSA &amp; EHSA</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../in-class/ice3.html" rel="" target="">
 <span class="dropdown-text">3 - Calibrating Spatial Interaction Models with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../in-class/ice4.html" rel="" target="">
 <span class="dropdown-text">4 - GDS and SIM with R</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../in-class/ice5.html" rel="" target="">
 <span class="dropdown-text">5 - Spatial Econometric Interaction Models (SIEM)</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-take-home-exercise" role="button" data-bs-toggle="dropdown" aria-expanded="false" rel="" target="">
 <span class="menu-text">Take-Home Exercise</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-take-home-exercise">    
        <li>
    <a class="dropdown-item" href="../take-home/the1.html" rel="" target="">
 <span class="dropdown-text">1 - Geospatial Analytics for Public Goods</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../take-home/the2.html" rel="" target="">
 <span class="dropdown-text">2 - Applied Spatial Interaction Models (WIP)</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/muhamad-ameer-noor/" rel="" target=""><i class="bi bi-linkedin" role="img" aria-label="Linkedin">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ameernoor" rel="" target=""><i class="bi bi-github" role="img" aria-label="Github">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://scholar.google.com/citations?user=TS_ilSMAAAAJ&amp;hl=en&amp;oi=ao" rel="" target=""><i class="bi bi-book" role="img" aria-label="Google Scholar">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link" data-scroll-target="#getting-started"><span class="header-section-number">2</span> Getting Started</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">3</span> Data Preparation</a>
  <ul class="collapse">
  <li><a href="#building-the-geographical-map" id="toc-building-the-geographical-map" class="nav-link" data-scroll-target="#building-the-geographical-map"><span class="header-section-number">3.1</span> Building the geographical map</a></li>
  <li><a href="#preparing-the-spatial-weight" id="toc-preparing-the-spatial-weight" class="nav-link" data-scroll-target="#preparing-the-spatial-weight"><span class="header-section-number">3.2</span> Preparing the Spatial Weight</a></li>
  </ul></li>
  <li><a href="#preparing-spflow-objects" id="toc-preparing-spflow-objects" class="nav-link" data-scroll-target="#preparing-spflow-objects"><span class="header-section-number">4</span> Preparing spflow objects</a></li>
  <li><a href="#model-calibration" id="toc-model-calibration" class="nav-link" data-scroll-target="#model-calibration"><span class="header-section-number">5</span> Model Calibration</a>
  <ul class="collapse">
  <li><a href="#the-base-model" id="toc-the-base-model" class="nav-link" data-scroll-target="#the-base-model"><span class="header-section-number">5.1</span> The Base Model</a></li>
  <li><a href="#working-with-model-control" id="toc-working-with-model-control" class="nav-link" data-scroll-target="#working-with-model-control"><span class="header-section-number">5.2</span> Working with model control</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">In-class Exercise 4 - Spatial Econometric Interaction Models (SIEM)</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Muhamad Ameer Noor </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 16, 2023</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">December 16, 2023</p>
    </div>
  </div>
    
  </div>
  

</header>

<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/ice5.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Illustration</figcaption>
</figure>
</div>
<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
</section>
<section id="getting-started" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Getting Started</h1>
<p>we manually install the git version instead of the one from CRAN.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"LukeCe/spflow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, we will load spflow and other R packages into R environment.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tmap, sf, spdep, sp, Matrix, spflow, reshape2, knitr, tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-preparation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Data Preparation</h1>
<p>Before we can calibrate Spatial Econometric Interaction Models by using <strong>spflow</strong> package, three data sets are required. They are: a spatial weights, a tibble data.frame consists of the origins, destination, flows, and distances between the origins and destination, and a tibble data.frame consists of the explanatory variables.</p>
<section id="building-the-geographical-map" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="building-the-geographical-map"><span class="header-section-number">3.1</span> Building the geographical map</h2>
<p>Shapefile will be imported into R environment as a sf tibble data.frame called <em>mpsz</em></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mpsz <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"../data/geospatial"</span>,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                <span class="at">layer =</span> <span class="st">"MPSZ-2019"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">3414</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">SUBZONE_N =</span> <span class="fu">as.factor</span>(SUBZONE_N),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">SUBZONE_C =</span> <span class="fu">as.factor</span>(SUBZONE_C),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">PLN_AREA_N =</span> <span class="fu">as.factor</span>(PLN_AREA_N),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">PLN_AREA_C =</span> <span class="fu">as.factor</span>(PLN_AREA_C),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">REGION_N =</span> <span class="fu">as.factor</span>(REGION_N),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">REGION_C =</span> <span class="fu">as.factor</span>(REGION_C),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `MPSZ-2019' from data source `C:\ameernoor\ISSS624\data\geospatial' using driver `ESRI Shapefile'
Simple feature collection with 332 features and 6 fields
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775
Geodetic CRS:  WGS 84</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the output</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mpsz)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 332
Columns: 7
$ SUBZONE_N  &lt;fct&gt; MARINA EAST, INSTITUTION HILL, ROBERTSON QUAY, JURONG ISLAN…
$ SUBZONE_C  &lt;fct&gt; MESZ01, RVSZ05, SRSZ01, WISZ01, MUSZ02, MPSZ05, WISZ03, WIS…
$ PLN_AREA_N &lt;fct&gt; MARINA EAST, RIVER VALLEY, SINGAPORE RIVER, WESTERN ISLANDS…
$ PLN_AREA_C &lt;fct&gt; ME, RV, SR, WI, MU, MP, WI, WI, SI, SI, BM, DT, SV, BM, BM,…
$ REGION_N   &lt;fct&gt; CENTRAL REGION, CENTRAL REGION, CENTRAL REGION, WEST REGION…
$ REGION_C   &lt;fct&gt; CR, CR, CR, WR, CR, CR, WR, WR, CR, CR, CR, CR, CR, CR, CR,…
$ geometry   &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((33222.98 29..., MULTIPOLYGON (…</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>busstop <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="at">dsn =</span> <span class="st">"../data/geospatial"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">layer =</span> <span class="st">"BusStop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs =</span> <span class="dv">3414</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `BusStop' from data source `C:\ameernoor\ISSS624\data\geospatial' using driver `ESRI Shapefile'
Simple feature collection with 5159 features and 3 fields
Geometry type: POINT
Dimension:     XY
Bounding box:  xmin: 3970.122 ymin: 26482.1 xmax: 48280.78 ymax: 52983.82
Projected CRS: SVY21</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check the data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(busstop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 5,159
Columns: 4
$ BUS_STOP_N &lt;chr&gt; "22069", "32071", "44331", "96081", "11561", "66191", "2338…
$ BUS_ROOF_N &lt;chr&gt; "B06", "B23", "B01", "B05", "B05", "B03", "B02A", "B02", "B…
$ LOC_DESC   &lt;chr&gt; "OPP CEVA LOGISTICS", "AFT TRACK 13", "BLK 239", "GRACE IND…
$ geometry   &lt;POINT [m]&gt; POINT (13576.31 32883.65), POINT (13228.59 44206.38),…</code></pre>
</div>
</div>
<p>In this study our analysis will be focused on planning subzone with bus stop. In view of this, the code chunk below will be used to perform Point-in-Polygon count analysis.</p>
<section id="this-is-a-code-fix-it-later" class="level5">
<h5 class="anchored" data-anchor-id="this-is-a-code-fix-it-later">this is a code, fix it later</h5>
<p>#####} eval: false mpsz_busstop &lt;- st_intersection(busstop, mpsz) %&gt;% filter = BUSSTOP_COUNT</p>
</section>
<section id="eval-can-be-set-to-true-once-the-flow-is-fix" class="level5">
<h5 class="anchored" data-anchor-id="eval-can-be-set-to-true-once-the-flow-is-fix">eval can be set to true once the flow is fix</h5>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>centroids <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>({</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">st_point_on_surface</span>(<span class="fu">st_geometry</span>(mpsz_busstop))</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>mpsz_nb <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"by_contiguity"</span> <span class="ot">=</span> <span class="fu">poly2nb</span>(mpsz_busstop),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"by_distance"</span> <span class="ot">=</span> <span class="fu">dnearneigh</span>(centroids, <span class="at">d1 =</span> <span class="dv">0</span>, <span class="at">d2 =</span> <span class="dv">5000</span>),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"by_knn"</span> <span class="ot">=</span> <span class="fu">knn2nb</span>(<span class="fu">knearneigh</span>(centroids,<span class="dv">3</span>))</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>mpsz_nb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="preparing-the-spatial-weight" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="preparing-the-spatial-weight"><span class="header-section-number">3.2</span> Preparing the Spatial Weight</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>schools <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../data/rds/schools.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>import the rest</p>
<section id="things-to-learn" class="level4">
<h4 class="anchored" data-anchor-id="things-to-learn">Things to learn</h4>
<p>Let us retrieve by using the code chunk below</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mpsz_nb <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../data/rds/mpsz_nb.rds"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mpsz_flow <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../data/rds/mpsz_flow.rds"</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>mpsz_var <span class="ot">&lt;-</span> <span class="fu">read_rds</span>(<span class="st">"../data/rds/mpsz_var.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>check the data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mpsz_nb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>List of 3
 $ by_contiguity:List of 313
  ..$ : int [1:4] 2 3 66 69
  ..$ : int [1:7] 1 3 32 37 38 69 80
  ..$ : int [1:7] 1 2 38 65 66 67 71
  ..$ : int [1:4] 47 75 87 281
  ..$ : int [1:2] 6 9
  ..$ : int [1:8] 5 7 8 9 10 12 16 19
  ..$ : int [1:5] 6 11 12 19 23
  ..$ : int [1:4] 6 19 28 31
  ..$ : int [1:7] 5 6 10 13 17 18 70
  ..$ : int [1:5] 6 9 12 13 16
  ..$ : int [1:5] 7 14 15 19 23
  ..$ : int [1:6] 6 7 10 16 20 23
  ..$ : int [1:6] 9 10 16 17 21 22
  ..$ : int [1:3] 11 15 23
  ..$ : int [1:5] 11 14 19 23 25
  ..$ : int [1:9] 6 10 12 13 20 22 27 29 34
  ..$ : int [1:5] 9 13 18 21 41
  ..$ : int [1:5] 9 17 39 41 70
  ..$ : int [1:9] 6 7 8 11 15 25 28 30 31
  ..$ : int [1:6] 12 16 23 27 32 280
  ..$ : int [1:6] 13 17 22 36 40 41
  ..$ : int [1:7] 13 16 21 29 34 35 36
  ..$ : int [1:10] 7 11 12 14 15 20 25 26 32 280
  ..$ : int [1:3] 25 26 33
  ..$ : int [1:8] 15 19 23 24 26 30 33 67
  ..$ : int [1:6] 23 24 25 32 33 38
  ..$ : int [1:5] 16 20 29 32 37
  ..$ : int [1:5] 8 19 30 31 64
  ..$ : int [1:5] 16 22 27 34 37
  ..$ : int [1:5] 19 25 28 64 67
  ..$ : int [1:4] 8 19 28 64
  ..$ : int [1:9] 2 20 23 26 27 33 37 38 280
  ..$ : int [1:6] 24 25 26 32 38 67
  ..$ : int [1:6] 16 22 29 35 37 42
  ..$ : int [1:5] 22 34 36 42 85
  ..$ : int [1:8] 21 22 35 40 41 42 68 85
  ..$ : int [1:7] 2 27 29 32 34 42 80
  ..$ : int [1:6] 2 3 26 32 33 67
  ..$ : int [1:6] 18 41 51 54 70 76
  ..$ : int [1:6] 21 36 41 43 46 68
  ..$ : int [1:8] 17 18 21 36 39 40 46 76
  ..$ : int [1:6] 34 35 36 37 80 85
  ..$ : int [1:6] 40 46 48 68 85 278
  ..$ : int [1:4] 61 82 110 121
  ..$ : int [1:5] 62 73 79 83 116
  ..$ : int [1:8] 40 41 43 49 68 76 115 278
  ..$ : int [1:5] 4 58 84 281 282
  ..$ : int [1:5] 43 68 85 136 278
  ..$ : int [1:5] 46 54 76 115 119
  ..$ : int [1:7] 80 85 86 125 126 131 136
  ..$ : int [1:6] 39 54 70 118 120 127
  ..$ : int [1:5] 61 78 111 121 132
  ..$ : int [1:4] 75 87 128 134
  ..$ : int [1:7] 39 49 51 76 119 120 135
  ..$ : int [1:3] 63 130 267
  ..$ : int [1:4] 112 118 138 139
  ..$ : int [1:3] 60 117 126
  ..$ : int [1:7] 47 84 116 122 123 266 282
  ..$ : int [1:4] 87 134 137 281
  ..$ : int [1:8] 57 69 74 77 78 86 117 126
  ..$ : int [1:5] 44 52 71 78 121
  ..$ : int [1:6] 45 73 79 82 110 116
  ..$ : int [1:4] 55 114 129 130
  ..$ : int [1:5] 28 30 31 67 84
  ..$ : int [1:5] 3 67 71 73 79
  ..$ : int [1:5] 1 3 69 71 78
  ..$ : int [1:11] 3 25 30 33 38 64 65 72 73 81 ...
  ..$ : int [1:6] 36 40 43 46 48 85
  ..$ : int [1:8] 1 2 60 66 74 77 78 80
  ..$ : int [1:5] 9 18 39 51 118
  ..$ : int [1:7] 3 61 65 66 78 79 82
  ..$ : int [1:5] 67 73 81 83 84
  ..$ : int [1:7] 45 62 65 67 72 79 83
  ..$ : int [1:5] 60 69 77 78 80
  ..$ : int [1:4] 4 53 87 281
  ..$ : int [1:5] 39 41 46 49 54
  ..$ : int [1:5] 60 69 74 80 86
  ..$ : int [1:7] 52 60 61 66 69 71 74
  ..$ : int [1:7] 45 62 65 71 73 82 110
  ..$ : int [1:9] 2 37 42 50 69 74 77 85 86
  ..$ : int [1:5] 67 72 83 84 266
  ..$ : int [1:5] 44 62 71 79 110
  ..$ : int [1:6] 45 72 73 81 116 266
  ..$ : int [1:7] 47 58 64 67 72 81 266
  ..$ : int [1:9] 35 36 42 43 48 50 68 80 136
  ..$ : int [1:5] 50 60 77 80 126
  ..$ : int [1:6] 4 53 59 75 134 281
  ..$ : int [1:9] 91 105 108 109 129 130 133 203 287
  ..$ : int [1:6] 96 103 122 140 178 282
  ..$ : int [1:7] 100 127 138 141 175 181 271
  ..$ : int [1:7] 88 108 129 133 139 179 185
  ..$ : int [1:6] 101 125 131 136 177 194
  ..$ : int [1:6] 98 102 134 137 188 192
  ..$ : int [1:5] 126 131 142 176 177
  ..$ : int [1:7] 101 119 124 135 175 190 193
  ..$ : int [1:7] 89 102 103 137 178 202 282
  ..$ : int [1:6] 99 104 106 107 144 145
  ..$ : int [1:7] 93 134 143 149 188 192 196
  ..$ : int [1:7] 97 107 142 145 176 182 187
  .. [list output truncated]
  ..- attr(*, "class")= chr "nb"
  ..- attr(*, "region.id")= chr [1:313] "1" "2" "3" "4" ...
  ..- attr(*, "call")= language poly2nb(pl = mpsz_busstop)
  ..- attr(*, "type")= chr "queen"
  ..- attr(*, "sym")= logi TRUE
 $ by_distance  :List of 313
  ..$ : int [1:91] 2 3 5 6 7 8 9 10 11 12 ...
  ..$ : int [1:90] 1 3 5 6 7 8 9 10 11 12 ...
  ..$ : int [1:91] 1 2 4 6 7 8 9 10 11 12 ...
  ..$ : int [1:56] 3 6 7 8 11 14 15 19 23 24 ...
  ..$ : int [1:34] 1 2 6 7 8 9 10 11 12 13 ...
  ..$ : int [1:62] 1 2 3 4 5 7 8 9 10 11 ...
  ..$ : int [1:74] 1 2 3 4 5 6 8 9 10 11 ...
  ..$ : int [1:64] 1 2 3 4 5 6 7 10 11 12 ...
  ..$ : int [1:53] 1 2 3 5 6 7 10 11 12 13 ...
  ..$ : int [1:74] 1 2 3 5 6 7 8 9 11 12 ...
  ..$ : int [1:75] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:75] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:75] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:76] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:76] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:81] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:64] 1 2 3 5 6 7 9 10 11 12 ...
  ..$ : int [1:44] 2 9 10 12 13 16 17 20 21 22 ...
  ..$ : int [1:73] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:80] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:72] 1 2 3 5 6 7 9 10 11 12 ...
  ..$ : int [1:82] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:79] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:81] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:82] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:81] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:83] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:75] 1 2 3 4 5 6 7 8 10 11 ...
  ..$ : int [1:86] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:78] 1 2 3 4 5 6 7 8 10 11 ...
  ..$ : int [1:67] 1 2 3 4 5 6 7 8 10 11 ...
  ..$ : int [1:86] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:83] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:87] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:85] 1 2 3 5 6 7 9 10 11 12 ...
  ..$ : int [1:75] 1 2 3 7 9 10 11 12 13 14 ...
  ..$ : int [1:89] 1 2 3 5 6 7 8 9 10 11 ...
  ..$ : int [1:86] 1 2 3 4 5 6 7 8 9 10 ...
  ..$ : int [1:41] 9 10 13 17 18 21 22 29 34 35 ...
  ..$ : int [1:59] 1 2 9 10 12 13 16 17 18 20 ...
  ..$ : int [1:49] 2 9 10 13 16 17 18 20 21 22 ...
  ..$ : int [1:89] 1 2 3 6 7 9 10 11 12 13 ...
  ..$ : int [1:63] 1 2 9 10 13 16 17 18 20 21 ...
  ..$ : int [1:97] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:93] 1 2 3 4 6 7 8 11 12 14 ...
  ..$ : int [1:54] 9 10 13 16 17 18 21 22 29 34 ...
  ..$ : int [1:71] 1 2 3 4 7 8 11 14 15 19 ...
  ..$ : int [1:65] 1 2 9 10 13 16 17 18 20 21 ...
  ..$ : int [1:43] 17 18 21 35 36 39 40 41 42 43 ...
  ..$ : int [1:87] 1 2 3 7 9 10 11 12 13 14 ...
  ..$ : int [1:38] 18 39 40 41 43 46 48 49 54 56 ...
  ..$ : int [1:99] 1 2 3 6 7 8 10 11 12 13 ...
  ..$ : int [1:16] 59 75 87 93 98 102 128 134 137 143 ...
  ..$ : int [1:41] 18 36 39 40 41 43 46 48 49 50 ...
  ..$ : int [1:12] 63 88 105 109 113 114 129 130 146 203 ...
  ..$ : int [1:30] 49 51 54 70 76 90 91 95 100 112 ...
  ..$ : int [1:96] 1 2 3 7 10 11 12 13 14 15 ...
  ..$ : int [1:84] 1 2 3 4 7 8 11 14 15 19 ...
  ..$ : int [1:35] 4 31 47 53 58 64 75 81 83 84 ...
  ..$ : int [1:101] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:95] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:95] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:13] 55 88 91 105 108 109 113 114 129 130 ...
  ..$ : int [1:85] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:92] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:95] 1 2 3 4 6 7 8 9 10 11 ...
  ..$ : int [1:85] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:66] 1 2 3 9 10 12 13 16 17 18 ...
  ..$ : int [1:99] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:24] 17 18 39 40 41 43 46 48 49 51 ...
  ..$ : int [1:96] 1 2 3 4 6 7 8 9 10 11 ...
  ..$ : int [1:89] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:92] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:100] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:21] 4 47 53 58 59 87 89 93 96 98 ...
  ..$ : int [1:39] 17 18 21 35 36 39 40 41 42 43 ...
  ..$ : int [1:97] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:97] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:94] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:93] 1 2 3 6 7 8 9 10 11 12 ...
  ..$ : int [1:90] 1 2 3 4 6 7 8 11 12 14 ...
  ..$ : int [1:95] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:94] 1 2 3 4 6 7 8 10 11 12 ...
  ..$ : int [1:88] 1 2 3 4 6 7 8 11 12 14 ...
  ..$ : int [1:74] 1 2 3 9 10 12 13 16 17 18 ...
  ..$ : int [1:93] 1 2 3 7 9 10 11 12 13 14 ...
  ..$ : int [1:27] 4 47 53 58 59 75 84 89 93 96 ...
  ..$ : int [1:21] 55 63 91 105 108 109 113 114 129 130 ...
  ..$ : int [1:68] 3 4 44 45 47 52 58 59 61 62 ...
  ..$ : int [1:45] 49 51 54 56 76 91 95 100 101 112 ...
  ..$ : int [1:32] 56 63 88 90 100 108 109 112 113 114 ...
  ..$ : int [1:51] 35 36 39 40 41 42 43 46 48 49 ...
  ..$ : int [1:27] 53 59 75 87 89 96 98 102 103 128 ...
  ..$ : int [1:71] 1 2 3 22 27 29 34 35 36 37 ...
  ..$ : int [1:47] 39 43 46 48 49 51 54 56 76 85 ...
  ..$ : int [1:59] 4 44 45 47 58 59 62 64 72 73 ...
  ..$ : int [1:82] 1 3 33 38 44 45 47 52 57 58 ...
  ..$ : int [1:23] 53 59 75 87 93 102 128 134 137 143 ...
  ..$ : int [1:79] 1 2 3 38 44 45 50 52 57 58 ...
  .. [list output truncated]
  ..- attr(*, "class")= chr "nb"
  ..- attr(*, "region.id")= chr [1:313] "1" "2" "3" "4" ...
  ..- attr(*, "call")= language dnearneigh(x = centroids, d1 = 0, d2 = 5000)
  ..- attr(*, "dnn")= num [1:2] 0 5000
  ..- attr(*, "bounds")= chr [1:2] "GE" "LE"
  ..- attr(*, "nbtype")= chr "distance"
  ..- attr(*, "sym")= logi TRUE
 $ by_knn       :List of 313
  ..$ : int [1:3] 2 66 69
  ..$ : int [1:3] 1 37 69
  ..$ : int [1:3] 38 65 71
  ..$ : int [1:3] 31 47 281
  ..$ : int [1:3] 6 7 12
  ..$ : int [1:3] 7 8 19
  ..$ : int [1:3] 11 14 23
  ..$ : int [1:3] 19 28 31
  ..$ : int [1:3] 10 13 17
  ..$ : int [1:3] 13 16 22
  ..$ : int [1:3] 7 14 15
  ..$ : int [1:3] 7 20 23
  ..$ : int [1:3] 10 16 22
  ..$ : int [1:3] 11 15 23
  ..$ : int [1:3] 11 14 25
  ..$ : int [1:3] 10 13 29
  ..$ : int [1:3] 9 21 36
  ..$ : int [1:3] 17 40 41
  ..$ : int [1:3] 8 11 15
  ..$ : int [1:3] 12 27 280
  ..$ : int [1:3] 17 35 36
  ..$ : int [1:3] 13 34 35
  ..$ : int [1:3] 11 14 280
  ..$ : int [1:3] 25 26 33
  ..$ : int [1:3] 24 26 30
  ..$ : int [1:3] 24 25 33
  ..$ : int [1:3] 20 29 37
  ..$ : int [1:3] 25 30 31
  ..$ : int [1:3] 16 27 34
  ..$ : int [1:3] 24 25 28
  ..$ : int [1:3] 8 28 30
  ..$ : int [1:3] 23 38 280
  ..$ : int [1:3] 24 26 38
  ..$ : int [1:3] 22 29 35
  ..$ : int [1:3] 22 34 42
  ..$ : int [1:3] 21 35 68
  ..$ : int [1:3] 2 27 29
  ..$ : int [1:3] 3 26 33
  ..$ : int [1:3] 41 46 76
  ..$ : int [1:3] 36 41 68
  ..$ : int [1:3] 18 39 40
  ..$ : int [1:3] 34 35 80
  ..$ : int [1:3] 46 48 85
  ..$ : int [1:3] 61 82 110
  ..$ : int [1:3] 62 81 83
  ..$ : int [1:3] 43 48 278
  ..$ : int [1:3] 4 58 266
  ..$ : int [1:3] 43 85 278
  ..$ : int [1:3] 54 76 119
  ..$ : int [1:3] 80 85 131
  ..$ : int [1:3] 54 118 120
  ..$ : int [1:3] 61 78 111
  ..$ : int [1:3] 75 93 134
  ..$ : int [1:3] 51 76 120
  ..$ : int [1:3] 63 130 267
  ..$ : int [1:3] 112 138 139
  ..$ : int [1:3] 60 86 117
  ..$ : int [1:3] 122 123 266
  ..$ : int [1:3] 75 87 137
  ..$ : int [1:3] 57 74 86
  ..$ : int [1:3] 44 52 82
  ..$ : int [1:3] 45 83 110
  ..$ : int [1:3] 55 114 130
  ..$ : int [1:3] 67 72 84
  ..$ : int [1:3] 3 67 73
  ..$ : int [1:3] 1 71 78
  ..$ : int [1:3] 33 65 73
  ..$ : int [1:3] 40 43 85
  ..$ : int [1:3] 1 74 78
  ..$ : int [1:3] 39 51 76
  ..$ : int [1:3] 3 66 82
  ..$ : int [1:3] 73 81 83
  ..$ : int [1:3] 72 79 82
  ..$ : int [1:3] 60 69 77
  ..$ : int [1:3] 59 87 281
  ..$ : int [1:3] 39 49 54
  ..$ : int [1:3] 74 80 86
  ..$ : int [1:3] 52 66 69
  ..$ : int [1:3] 44 73 82
  ..$ : int [1:3] 42 77 86
  ..$ : int [1:3] 72 83 266
  ..$ : int [1:3] 44 73 79
  ..$ : int [1:3] 45 62 81
  ..$ : int [1:3] 72 81 266
  ..$ : int [1:3] 43 48 68
  ..$ : int [1:3] 60 74 77
  ..$ : int [1:3] 59 75 281
  ..$ : int [1:3] 109 129 130
  ..$ : int [1:3] 96 103 140
  ..$ : int [1:3] 100 141 181
  ..$ : int [1:3] 108 133 179
  ..$ : int [1:3] 125 136 177
  ..$ : int [1:3] 134 188 192
  ..$ : int [1:3] 126 142 176
  ..$ : int [1:3] 135 141 193
  ..$ : int [1:3] 89 102 178
  ..$ : int [1:3] 104 106 107
  ..$ : int [1:3] 143 149 192
  ..$ : int [1:3] 107 182 187
  .. [list output truncated]
  ..- attr(*, "region.id")= chr [1:313] "1" "2" "3" "4" ...
  ..- attr(*, "call")= language knearneigh(x = centroids, k = 3)
  ..- attr(*, "sym")= logi FALSE
  ..- attr(*, "type")= chr "knn"
  ..- attr(*, "knn-k")= num 3
  ..- attr(*, "class")= chr "nb"</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mpsz_flow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 97,969
Columns: 4
$ ORIGIN_SZ &lt;chr&gt; "RVSZ05", "SRSZ01", "MUSZ02", "MPSZ05", "SISZ01", "BMSZ17", …
$ DESTIN_SZ &lt;chr&gt; "RVSZ05", "RVSZ05", "RVSZ05", "RVSZ05", "RVSZ05", "RVSZ05", …
$ DISTANCE  &lt;dbl&gt; 0.0000, 305.7370, 951.8314, 5254.0664, 4975.0021, 3176.1592,…
$ TRIPS     &lt;dbl&gt; 67, 549, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mpsz_var)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 313
Columns: 14
$ SZ_NAME        &lt;chr&gt; "INSTITUTION HILL", "ROBERTSON QUAY", "FORT CANNING", "…
$ SZ_CODE        &lt;chr&gt; "RVSZ05", "SRSZ01", "MUSZ02", "MPSZ05", "SISZ01", "BMSZ…
$ BUSSTOP_COUNT  &lt;int&gt; 2, 10, 6, 2, 1, 10, 5, 4, 21, 11, 2, 9, 6, 1, 4, 7, 24,…
$ AGE7_12        &lt;dbl&gt; 330, 320, 0, 0, 200, 0, 0, 0, 350, 470, 0, 300, 390, 0,…
$ AGE13_24       &lt;dbl&gt; 360, 350, 10, 0, 260, 0, 0, 0, 460, 1160, 0, 760, 890, …
$ AGE25_64       &lt;dbl&gt; 2260, 2200, 30, 0, 1440, 0, 0, 0, 2600, 6260, 630, 4350…
$ geometry       &lt;MULTIPOLYGON [m]&gt; MULTIPOLYGON (((28481.45 30..., MULTIPOLYG…
$ SCHOOL_COUNT   &lt;int&gt; 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 1, 1, 0, 0, 0, 1, 0, 0…
$ BUSINESS_COUNT &lt;int&gt; 6, 4, 7, 0, 1, 11, 15, 1, 10, 1, 17, 6, 0, 0, 51, 2, 3,…
$ RETAILS_COUNT  &lt;int&gt; 26, 207, 17, 0, 84, 14, 52, 0, 460, 34, 263, 55, 37, 1,…
$ FINSERV_COUNT  &lt;int&gt; 3, 18, 0, 0, 29, 4, 6, 0, 34, 4, 26, 4, 3, 6, 59, 3, 8,…
$ ENTERTN_COUNT  &lt;int&gt; 0, 6, 3, 0, 2, 0, 0, 0, 1, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0…
$ FB_COUNT       &lt;int&gt; 4, 38, 4, 0, 38, 15, 5, 0, 20, 0, 9, 25, 0, 0, 9, 1, 3,…
$ LR_COUNT       &lt;int&gt; 3, 11, 7, 0, 20, 0, 0, 0, 19, 2, 4, 4, 1, 1, 13, 0, 17,…</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="preparing-spflow-objects" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Preparing spflow objects</h1>
<p>For our model, we choose the contiguity based neighborhood structure.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>mpsz_net <span class="ot">&lt;-</span> <span class="fu">spflow_network</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_net =</span> <span class="st">"sg"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">node_neighborhood =</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nb2mat</span>(mpsz_nb<span class="sc">$</span>by_contiguity),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">node_data =</span> mpsz_var,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">node_key_column =</span> <span class="st">"SZ_CODE"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>mpsz_net</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial network nodes with id: sg
--------------------------------------------------
Number of nodes: 313
Average number of links per node: 6.077
Density of the neighborhood matrix: 1.94% (non-zero connections)

Data on nodes:
                SZ_NAME SZ_CODE BUSSTOP_COUNT AGE7_12 AGE13_24 AGE25_64
1      INSTITUTION HILL  RVSZ05             2     330      360     2260
2        ROBERTSON QUAY  SRSZ01            10     320      350     2200
3          FORT CANNING  MUSZ02             6       0       10       30
4      MARINA EAST (MP)  MPSZ05             2       0        0        0
5               SENTOSA  SISZ01             1     200      260     1440
6        CITY TERMINALS  BMSZ17            10       0        0        0
---                 ---     ---           ---     ---      ---      ---
308            NEE SOON  YSSZ07            12      90      140      590
309       UPPER THOMSON  BSSZ01            47    1590     3660    15980
310          SHANGRI-LA  AMSZ05            12     810     1920     9650
311          TOWNSVILLE  AMSZ04             9     980     2000    11320
312           MARYMOUNT  BSSZ02            25    1610     4060    16860
313 TUAS VIEW EXTENSION  TSSZ06            11       0        0        0
    SCHOOL_COUNT BUSINESS_COUNT RETAILS_COUNT FINSERV_COUNT ENTERTN_COUNT
1              1              6            26             3             0
2              0              4           207            18             6
3              0              7            17             0             3
4              0              0             0             0             0
5              0              1            84            29             2
6              0             11            14             4             0
---          ---            ---           ---           ---           ---
308            0              0             7             0             0
309            3             21           305            30             0
310            3              0            53             9             0
311            1              0            83            11             0
312            3             19           135             8             0
313            0             53             3             1             0
    FB_COUNT LR_COUNT COORD_X COORD_Y
1          4        3  103.84    1.29
2         38       11  103.84    1.29
3          4        7  103.85    1.29
4          0        0  103.88    1.29
5         38       20  103.83    1.25
6         15        0  103.85    1.26
---      ---      ---     ---     ---
308        0        0  103.81     1.4
309        5       11  103.83    1.36
310        0        0  103.84    1.37
311        1        1  103.85    1.36
312        3       11  103.84    1.35
313        0        0  103.61    1.26</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Functions">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Functions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ul>
<li><a href="https://cran.r-project.org/web/packages/spflow/spflow.pdf">spflow_network</a> from <strong>spflow</strong> package is used to create a spatial interaction network. In this code, <code>mpsz_net</code> is defined as a spatial interaction network with several parameters:
<ul>
<li><code>id_net</code>: A unique identifier for the network, set as “sg” in this case.</li>
<li><code>node_neighborhood</code>: A matrix that represents the neighborhood structure of the nodes (areas or locations) in the network, created from <code>mpsz_nb$by_contiguity</code> using the <code>nb2mat</code> function (which converts neighbor objects into matrices).</li>
<li><code>node_data</code>: A data frame containing variables associated with each node (e.g., demographic data, economic indicators), here specified as <code>mpsz_var</code>.</li>
<li><code>node_key_column</code>: The column in <code>node_data</code> that uniquely identifies each node, set as “SZ_CODE”.</li>
</ul></li>
<li>The last line, <code>mpsz_net</code>, displays the created spatial interaction network.</li>
</ul>
</div>
</div>
</div>
<p>Do for destinations.</p>
<p>In <strong>spflow</strong> package, <a href="https://lukece.github.io/spflow/reference/spflow_network_pair.html"><code>spflow_network_pair()</code></a></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mpsz_net_pairs <span class="ot">&lt;-</span> <span class="fu">spflow_network_pair</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_orig_net =</span> <span class="st">"sg"</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">id_dest_net =</span> <span class="st">"sg"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pair_data =</span> mpsz_flow,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig_key_column =</span> <span class="st">"ORIGIN_SZ"</span>,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">dest_key_column =</span> <span class="st">"DESTIN_SZ"</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>mpsz_net_pairs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Spatial network pair with id: sg_sg
--------------------------------------------------
Origin network id: sg (with 313 nodes)
Destination network id: sg (with 313 nodes)
Number of pairs: 97969
Completeness of pairs: 100.00% (97969/97969)

Data on node-pairs:
      DESTIN_SZ ORIGIN_SZ DISTANCE TRIPS
1        RVSZ05    RVSZ05        0    67
314      SRSZ01    RVSZ05   305.74   251
627      MUSZ02    RVSZ05   951.83     0
940      MPSZ05    RVSZ05  5254.07     0
1253     SISZ01    RVSZ05     4975     0
1566     BMSZ17    RVSZ05  3176.16     0
---         ---       ---      ---   ---
96404    YSSZ07    TSSZ06 26972.97     0
96717    BSSZ01    TSSZ06 25582.48     0
97030    AMSZ05    TSSZ06 26714.79     0
97343    AMSZ04    TSSZ06 27572.74     0
97656    BSSZ02    TSSZ06  26681.7     0
97969    TSSZ06    TSSZ06        0   270</code></pre>
</div>
</div>
<p>Both data sources are consistent. For example, if some of the origins in the sp_network_pair-class are not identified with the nodes in the sp_network_nodes-class an error will be raised.</p>
<p><a href="https://lukece.github.io/spflow/reference/spflow_network_multi.html"><code>spflow_network_multi()</code></a></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>mpsz_multi_net <span class="ot">&lt;-</span> <span class="fu">spflow_network_multi</span>(mpsz_net,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                                       mpsz_net_pairs)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>mpsz_multi_net</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Collection of spatial network nodes and pairs
--------------------------------------------------
Contains 1 spatial network nodes  
    With id :  sg
Contains 1 spatial network pairs  
    With id :  sg_sg

Availability of origin-destination pair information:

 ID_ORIG_NET ID_DEST_NET ID_NET_PAIR COMPLETENESS     C_PAIRS  C_ORIG  C_DEST
          sg          sg       sg_sg      100.00% 97969/97969 313/313 313/313</code></pre>
</div>
</div>
<p>the next step is using correlation analysis to check for multicollinearity. it is done using <code>pair_cor()</code> to create the correlation matrix and <code>cor_image()</code> to plot the correlation matrix into a correlogram.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#} eval: false</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>cor_formula <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">1</span><span class="sc">+</span> TRIPS) <span class="sc">~</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  BUSSTOP_COUNT <span class="sc">+</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  AGE7_12 <span class="sc">+</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  AGE13_24 <span class="sc">+</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  AGE25_64 <span class="sc">+</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  SCHOOL_COUNT <span class="sc">+</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  BUSINESS_COUNT <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  RETAILS_COUNT <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  FINSERV_COUNT <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">P_</span>(<span class="fu">log</span>(DISTANCE <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>cor_mat <span class="ot">&lt;-</span> <span class="fu">pair_cor</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  mpsz_multi_net,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">spflow_formula =</span> cor_formula,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_lags_x =</span> <span class="cn">FALSE</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(cor_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  (Intercept)     (Intra)        D_BUSSTOP_COUNT    D_AGE7_12       
 Min.   : NA   Min.   :-0.6000   Min.   :0.0000   Min.   :-0.19137  
 1st Qu.: NA   1st Qu.: 0.0000   1st Qu.:0.0000   1st Qu.: 0.00000  
 Median : NA   Median : 0.0000   Median :0.0279   Median : 0.02124  
 Mean   :NaN   Mean   : 0.1882   Mean   :0.1688   Mean   : 0.17425  
 3rd Qu.: NA   3rd Qu.: 0.5343   3rd Qu.:0.1978   3rd Qu.: 0.09379  
 Max.   : NA   Max.   : 1.0000   Max.   :1.0000   Max.   : 1.00000  
 NA's   :28    NA's   :1         NA's   :1        NA's   :1         
   D_AGE13_24         D_AGE25_64       D_SCHOOL_COUNT     D_BUSINESS_COUNT   
 Min.   :-0.18178   Min.   :-0.18513   Min.   :-0.18700   Min.   :-0.191368  
 1st Qu.: 0.00000   1st Qu.: 0.00000   1st Qu.: 0.00000   1st Qu.:-0.008893  
 Median : 0.02271   Median : 0.02303   Median : 0.01979   Median : 0.000000  
 Mean   : 0.18286   Mean   : 0.18580   Mean   : 0.16638   Mean   : 0.027354  
 3rd Qu.: 0.11567   3rd Qu.: 0.13622   3rd Qu.: 0.11500   3rd Qu.: 0.003110  
 Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.000000  
 NA's   :1          NA's   :1          NA's   :1          NA's   :1          
 D_RETAILS_COUNT     D_FINSERV_COUNT     O_BUSSTOP_COUNT    O_AGE7_12       
 Min.   :-0.067274   Min.   :-0.056597   Min.   :0.0000   Min.   :-0.19137  
 1st Qu.: 0.000000   1st Qu.: 0.000000   1st Qu.:0.0000   1st Qu.: 0.00000  
 Median : 0.006356   Median : 0.008892   Median :0.0279   Median : 0.02124  
 Mean   : 0.096878   Mean   : 0.108154   Mean   :0.1688   Mean   : 0.17522  
 3rd Qu.: 0.098401   3rd Qu.: 0.126999   3rd Qu.:0.1978   3rd Qu.: 0.10686  
 Max.   : 1.000000   Max.   : 1.000000   Max.   :1.0000   Max.   : 1.00000  
 NA's   :1           NA's   :1           NA's   :1        NA's   :1         
   O_AGE13_24         O_AGE25_64       O_SCHOOL_COUNT     O_BUSINESS_COUNT   
 Min.   :-0.18178   Min.   :-0.18513   Min.   :-0.18700   Min.   :-0.191368  
 1st Qu.: 0.00000   1st Qu.: 0.00000   1st Qu.: 0.00000   1st Qu.:-0.008893  
 Median : 0.02271   Median : 0.02303   Median : 0.01979   Median : 0.000000  
 Mean   : 0.18382   Mean   : 0.18682   Mean   : 0.16728   Mean   : 0.026554  
 3rd Qu.: 0.12868   3rd Qu.: 0.14988   3rd Qu.: 0.12718   3rd Qu.: 0.003110  
 Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.000000  
 NA's   :1          NA's   :1          NA's   :1          NA's   :1          
 O_RETAILS_COUNT     O_FINSERV_COUNT     I_BUSSTOP_COUNT      I_AGE7_12       
 Min.   :-0.067274   Min.   :-0.056597   Min.   :-0.46608   Min.   :-0.33712  
 1st Qu.: 0.000000   1st Qu.: 0.000000   1st Qu.: 0.01519   1st Qu.: 0.01840  
 Median : 0.006356   Median : 0.008892   Median : 0.02303   Median : 0.04466  
 Mean   : 0.096696   Mean   : 0.108262   Mean   : 0.23445   Mean   : 0.22889  
 3rd Qu.: 0.098401   3rd Qu.: 0.128450   3rd Qu.: 0.52082   3rd Qu.: 0.39584  
 Max.   : 1.000000   Max.   : 1.000000   Max.   : 1.00000   Max.   : 1.00000  
 NA's   :1           NA's   :1           NA's   :1          NA's   :1         
   I_AGE13_24         I_AGE25_64       I_SCHOOL_COUNT     I_BUSINESS_COUNT   
 Min.   :-0.33836   Min.   :-0.34915   Min.   :-0.32910   Min.   :-0.240081  
 1st Qu.: 0.02015   1st Qu.: 0.02064   1st Qu.: 0.01830   1st Qu.:-0.009503  
 Median : 0.04597   Median : 0.04527   Median : 0.03967   Median : 0.015407  
 Mean   : 0.23500   Mean   : 0.23850   Mean   : 0.22230   Mean   : 0.096704  
 3rd Qu.: 0.42210   3rd Qu.: 0.44862   3rd Qu.: 0.41029   3rd Qu.: 0.083898  
 Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.000000  
 NA's   :1          NA's   :1          NA's   :1          NA's   :1          
 I_RETAILS_COUNT    I_FINSERV_COUNT    P_log(DISTANCE + 1) Y_log(1 + TRIPS)  
 Min.   :-0.31203   Min.   :-0.33019   Min.   :-0.60001    Min.   :-0.42738  
 1st Qu.: 0.00602   1st Qu.: 0.01028   1st Qu.:-0.32964    1st Qu.: 0.07293  
 Median : 0.03559   Median : 0.03479   Median :-0.05526    Median : 0.11732  
 Mean   : 0.17265   Mean   : 0.18377   Mean   :-0.08042    Mean   : 0.11887  
 3rd Qu.: 0.35867   3rd Qu.: 0.44747   3rd Qu.: 0.04883    3rd Qu.: 0.14810  
 Max.   : 1.00000   Max.   : 1.00000   Max.   : 1.00000    Max.   : 1.00000  
 NA's   :1          NA's   :1          NA's   :1           NA's   :1         </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(cor_mat) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">substr</span>(<span class="fu">colnames</span>(cor_mat),<span class="dv">1</span>,<span class="dv">3</span>),<span class="st">"..."</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_image</span>(cor_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="ice5_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="model-calibration" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Model Calibration</h1>
<section id="the-base-model" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="the-base-model"><span class="header-section-number">5.1</span> The Base Model</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>base_model <span class="ot">&lt;-</span> <span class="fu">spflow</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">spflow_formula =</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> TRIPS) <span class="sc">~</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">O_</span>(BUSSTOP_COUNT <span class="sc">+</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>         AGE25_64) <span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">D_</span>(SCHOOL_COUNT <span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>         BUSINESS_COUNT <span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>         RETAILS_COUNT <span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>         FINSERV_COUNT) <span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>         <span class="fu">P_</span>(<span class="fu">log</span>(DISTANCE <span class="sc">+</span> <span class="dv">1</span>)),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">spflow_networks =</span> mpsz_multi_net)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>base_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------
Spatial interaction model estimated by: MLE  
Spatial correlation structure: SDM (model_9)
Dependent variable: log(1 + TRIPS)

--------------------------------------------------
Coefficients:
                          est     sd   t.stat  p.val
rho_d                   0.680  0.004  192.553  0.000
rho_o                   0.678  0.004  187.733  0.000
rho_w                  -0.396  0.006  -65.591  0.000
(Intercept)             0.410  0.065    6.266  0.000
(Intra)                 1.313  0.081   16.263  0.000
D_SCHOOL_COUNT          0.017  0.002    7.885  0.000
D_SCHOOL_COUNT.lag1     0.002  0.004    0.551  0.581
D_BUSINESS_COUNT        0.000  0.000    3.015  0.003
D_BUSINESS_COUNT.lag1   0.000  0.000   -0.249  0.804
D_RETAILS_COUNT         0.000  0.000   -0.306  0.759
D_RETAILS_COUNT.lag1    0.000  0.000    0.152  0.880
D_FINSERV_COUNT         0.002  0.000    6.787  0.000
D_FINSERV_COUNT.lag1   -0.002  0.001   -3.767  0.000
O_BUSSTOP_COUNT         0.002  0.000    6.807  0.000
O_BUSSTOP_COUNT.lag1   -0.001  0.000   -2.364  0.018
O_AGE25_64              0.000  0.000    7.336  0.000
O_AGE25_64.lag1         0.000  0.000   -2.797  0.005
P_log(DISTANCE + 1)    -0.050  0.007   -6.793  0.000

--------------------------------------------------
R2_corr: 0.6942944  
Observations: 97969  
Model coherence: Validated</code></pre>
</div>
</div>
<div class="notebox lightbulb">
<p>note that many of the lag1 are statistically significant. this signifies that neighboring area can actually affect the number of trips as well.</p>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>old_par <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>),</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">spflow_moran_plots</span>(base_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="ice5_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(old_par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>corr_residual <span class="ot">&lt;-</span> <span class="fu">pair_cor</span>(base_model)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(corr_residual) <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">colnames</span>(corr_residual), <span class="dv">1</span>,<span class="dv">3</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cor_image</span>(corr_residual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="ice5_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="working-with-model-control" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="working-with-model-control"><span class="header-section-number">5.2</span> Working with model control</h2>
<p>the original code is for model_8</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>spflow_formula <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> TRIPS) <span class="sc">~</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">O_</span>(BUSSTOP_COUNT <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>         AGE25_64) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">D_</span>(SCHOOL_COUNT <span class="sc">+</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>       BUSINESS_COUNT <span class="sc">+</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>       RETAILS_COUNT <span class="sc">+</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>       FINSERV_COUNT) <span class="sc">+</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">P_</span>(<span class="fu">log</span>(DISTANCE <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>model_control <span class="ot">&lt;-</span> <span class="fu">spflow_control</span>(</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_method =</span> <span class="st">"mle"</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="st">"model_8"</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>mle_model8 <span class="ot">&lt;-</span> <span class="fu">spflow</span>(</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  spflow_formula,</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">spflow_networks =</span> mpsz_multi_net,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_control =</span> model_control)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>mle_model8</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------
Spatial interaction model estimated by: MLE  
Spatial correlation structure: SDM (model_8)
Dependent variable: log(1 + TRIPS)

--------------------------------------------------
Coefficients:
                          est     sd    t.stat  p.val
rho_d                   0.689  0.003   196.832  0.000
rho_o                   0.687  0.004   192.214  0.000
rho_w                  -0.473  0.003  -142.469  0.000
(Intercept)             1.086  0.049    22.275  0.000
(Intra)                 0.840  0.075    11.255  0.000
D_SCHOOL_COUNT          0.019  0.002     8.896  0.000
D_SCHOOL_COUNT.lag1     0.019  0.004     5.130  0.000
D_BUSINESS_COUNT        0.000  0.000     3.328  0.001
D_BUSINESS_COUNT.lag1   0.000  0.000     1.664  0.096
D_RETAILS_COUNT         0.000  0.000    -0.414  0.679
D_RETAILS_COUNT.lag1    0.000  0.000    -0.171  0.864
D_FINSERV_COUNT         0.002  0.000     6.150  0.000
D_FINSERV_COUNT.lag1   -0.003  0.001    -4.601  0.000
O_BUSSTOP_COUNT         0.003  0.000     7.676  0.000
O_BUSSTOP_COUNT.lag1    0.000  0.000     0.552  0.581
O_AGE25_64              0.000  0.000     6.870  0.000
O_AGE25_64.lag1         0.000  0.000    -0.462  0.644
P_log(DISTANCE + 1)    -0.125  0.005   -22.865  0.000

--------------------------------------------------
R2_corr: 0.6965974  
Observations: 97969  
Model coherence: Validated</code></pre>
</div>
</div>
<p>next, change to model_1</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>spflow_formula <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="dv">1</span> <span class="sc">+</span> TRIPS) <span class="sc">~</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">O_</span>(BUSSTOP_COUNT <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>         AGE25_64) <span class="sc">+</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">D_</span>(SCHOOL_COUNT <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>       BUSINESS_COUNT <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>       RETAILS_COUNT <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>       FINSERV_COUNT) <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">P_</span>(<span class="fu">log</span>(DISTANCE <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>model_control <span class="ot">&lt;-</span> <span class="fu">spflow_control</span>(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_method =</span> <span class="st">"mle"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="st">"model_1"</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>mle_model1 <span class="ot">&lt;-</span> <span class="fu">spflow</span>(</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  spflow_formula,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">spflow_networks =</span> mpsz_multi_net,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimation_control =</span> model_control)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>mle_model1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>--------------------------------------------------
Spatial interaction model estimated by: OLS  
Spatial correlation structure: SLX (model_1)
Dependent variable: log(1 + TRIPS)

--------------------------------------------------
Coefficients:
                          est     sd    t.stat  p.val
(Intercept)            11.384  0.069   164.255  0.000
(Intra)                -6.006  0.112   -53.393  0.000
D_SCHOOL_COUNT          0.093  0.003    28.599  0.000
D_SCHOOL_COUNT.lag1     0.255  0.006    44.905  0.000
D_BUSINESS_COUNT        0.001  0.000    10.036  0.000
D_BUSINESS_COUNT.lag1   0.003  0.000    18.274  0.000
D_RETAILS_COUNT         0.000  0.000    -1.940  0.052
D_RETAILS_COUNT.lag1    0.000  0.000    -2.581  0.010
D_FINSERV_COUNT         0.005  0.000    10.979  0.000
D_FINSERV_COUNT.lag1   -0.016  0.001   -17.134  0.000
O_BUSSTOP_COUNT         0.014  0.001    25.865  0.000
O_BUSSTOP_COUNT.lag1    0.015  0.001    21.728  0.000
O_AGE25_64              0.000  0.000    14.479  0.000
O_AGE25_64.lag1         0.000  0.000    14.452  0.000
P_log(DISTANCE + 1)    -1.281  0.008  -165.327  0.000

--------------------------------------------------
R2_corr: 0.2831458  
Observations: 97969  
Model coherence: Validated</code></pre>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>